{"version":3,"file":"container.js","sourceRoot":"","sources":["../../../../../../src/extra/container/webm/container.ts"],"names":[],"mappings":"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","sourcesContent":["import { createCipheriv, randomBytes, randomFillSync } from \"crypto\";\n\nimport { BitWriter2, BufferChain } from \"../../../../../common/src\";\nimport { OpusRtpPayload } from \"../../../codec\";\nimport * as EBML from \"./ebml\";\n\nexport class WEBMContainer {\n  readonly ebmlHeader = EBML.build(\n    EBML.element(EBML.ID.EBML, [\n      EBML.element(EBML.ID.EBMLVersion, EBML.number(1)),\n      EBML.element(EBML.ID.EBMLReadVersion, EBML.number(1)),\n      EBML.element(EBML.ID.EBMLMaxIDLength, EBML.number(4)),\n      EBML.element(EBML.ID.EBMLMaxSizeLength, EBML.number(8)),\n      EBML.element(EBML.ID.DocType, EBML.string(\"webm\")),\n      EBML.element(EBML.ID.DocTypeVersion, EBML.number(2)),\n      EBML.element(EBML.ID.DocTypeReadVersion, EBML.number(2)),\n    ]),\n  );\n  trackEntries: EBML.EBMLData[] = [];\n  private trackIvs: { [trackNumber: number]: Uint32Array } = {};\n  trackKeyIds: { [trackNumber: number]: Buffer } = {};\n  encryptionKey?: Buffer;\n  readonly encryptionKeyID = randomBytes(16);\n\n  constructor(\n    tracks: {\n      width?: number;\n      height?: number;\n      roll?: number;\n      kind: \"audio\" | \"video\";\n      codec: SupportedCodec;\n      trackNumber: number;\n    }[],\n    encryptionKey?: Buffer,\n  ) {\n    this.encryptionKey = encryptionKey;\n\n    this.trackEntries = tracks.map(\n      ({ width, height, kind, codec, trackNumber, roll }) => {\n        const track = this.createTrackEntry(kind, trackNumber, codec, {\n          width,\n          height,\n          roll,\n        });\n        const ivCounter = new Uint32Array(2);\n        randomFillSync(ivCounter);\n        this.trackIvs[trackNumber] = ivCounter;\n\n        return track;\n      },\n    );\n  }\n\n  createTrackEntry(\n    kind: string,\n    trackNumber: number,\n    codec: string,\n    {\n      width,\n      height,\n      roll,\n    }: Partial<{\n      kind: string;\n      width: number;\n      roll: number;\n      height: number;\n    }> = {},\n  ) {\n    const trackElements: EBML.EBMLData[] = [];\n\n    if (kind === \"video\") {\n      width ??= 640;\n      height ??= 360;\n      roll ??= 0;\n      trackElements.push(\n        EBML.element(EBML.ID.Video, [\n          EBML.element(EBML.ID.PixelWidth, EBML.number(width)),\n          EBML.element(EBML.ID.PixelHeight, EBML.number(height)),\n          EBML.element(EBML.ID.Projection, [\n            EBML.element(EBML.ID.ProjectionType, EBML.number(0)),\n            EBML.element(EBML.ID.ProjectionPoseRoll, EBML.float(roll)),\n          ]),\n        ]),\n      );\n    } else {\n      trackElements.push(\n        EBML.element(EBML.ID.Audio, [\n          EBML.element(EBML.ID.SamplingFrequency, EBML.float(48000.0)),\n          EBML.element(EBML.ID.Channels, EBML.number(2)),\n        ]),\n      );\n      // only support OPUS\n      trackElements.push(\n        EBML.element(\n          EBML.ID.CodecPrivate,\n          EBML.bytes(OpusRtpPayload.createCodecPrivate()),\n        ),\n      );\n    }\n\n    if (this.encryptionKey) {\n      const encryptionKeyID = this.encryptionKeyID;\n      this.trackKeyIds[trackNumber] = encryptionKeyID;\n\n      trackElements.push(\n        EBML.element(\n          EBML.ID.ContentEncodings,\n          EBML.element(EBML.ID.ContentEncoding, [\n            EBML.element(EBML.ID.ContentEncodingOrder, EBML.number(0)),\n            EBML.element(EBML.ID.ContentEncodingScope, EBML.number(1)),\n            EBML.element(EBML.ID.ContentEncodingType, EBML.number(1)),\n            EBML.element(EBML.ID.ContentEncryption, [\n              EBML.element(EBML.ID.EncryptionAlgorithm, EBML.number(5)),\n              EBML.element(\n                EBML.ID.EncryptionKeyID,\n                EBML.bytes(encryptionKeyID),\n              ),\n              EBML.element(\n                EBML.ID.ContentEncAESSettings,\n                EBML.element(EBML.ID.AESSettingsCipherMode, EBML.number(1)),\n              ),\n            ]),\n          ]),\n        ),\n      );\n    }\n\n    const trackEntry = EBML.element(EBML.ID.TrackEntry, [\n      EBML.element(EBML.ID.TrackNumber, EBML.number(trackNumber)),\n      EBML.element(EBML.ID.TrackUID, EBML.number(trackNumber)),\n      EBML.element(EBML.ID.CodecName, EBML.string(codec)),\n      EBML.element(EBML.ID.TrackType, EBML.number(kind === \"video\" ? 1 : 2)),\n      EBML.element(\n        EBML.ID.CodecID,\n        EBML.string(`${kind === \"video\" ? \"V\" : \"A\"}_${codec}`),\n      ),\n      ...trackElements,\n    ]);\n    return trackEntry;\n  }\n\n  createSegment(\n    /**ms */\n    duration?: number,\n  ) {\n    const elements = [\n      EBML.element(EBML.ID.TimecodeScale, EBML.number(millisecond)),\n      EBML.element(EBML.ID.MuxingApp, EBML.string(\"webrtc\")),\n      EBML.element(EBML.ID.WritingApp, EBML.string(\"webrtc\")),\n    ];\n    if (duration != undefined) {\n      elements.push(EBML.element(EBML.ID.Duration, EBML.float(duration)));\n    }\n    return EBML.build(\n      EBML.unknownSizeElement(EBML.ID.Segment, [\n        EBML.element(EBML.ID.SeekHead, []),\n        EBML.element(EBML.ID.Info, elements),\n        EBML.element(EBML.ID.Tracks, this.trackEntries),\n      ]),\n    );\n  }\n\n  createDuration(\n    /**ms */\n    duration: number,\n  ) {\n    return EBML.build(EBML.element(EBML.ID.Duration, EBML.float(duration)));\n  }\n\n  createCuePoint(\n    relativeTimestamp: number,\n    trackNumber: number,\n    clusterPosition: number,\n    blockNumber: number,\n  ) {\n    return EBML.element(EBML.ID.CuePoint, [\n      EBML.element(EBML.ID.CueTime, EBML.number(relativeTimestamp)),\n      EBML.element(EBML.ID.CueTrackPositions, [\n        EBML.element(EBML.ID.CueTrack, EBML.number(trackNumber)),\n        EBML.element(EBML.ID.CueClusterPosition, EBML.number(clusterPosition)),\n        EBML.element(EBML.ID.CueBlockNumber, EBML.number(blockNumber)),\n      ]),\n    ]);\n  }\n\n  createCues(cuePoints: EBML.EBMLData[]) {\n    return EBML.build(EBML.element(EBML.ID.Cues, cuePoints));\n  }\n\n  createCluster(timecode: number) {\n    return EBML.build(\n      EBML.unknownSizeElement(EBML.ID.Cluster, [\n        EBML.element(EBML.ID.Timecode, EBML.number(timecode)),\n      ]),\n    );\n  }\n\n  createSimpleBlock(\n    frame: Buffer,\n    isKeyframe: boolean,\n    trackNumber: number,\n    relativeTimestamp: number,\n  ) {\n    const elementId = Buffer.from([0xa3]);\n\n    if (this.encryptionKey) {\n      // 4.7 Signal Byte Format\n      //  0 1 2 3 4 5 6 7\n      // +-+-+-+-+-+-+-+-+\n      // |X|   RSV   |P|E|\n      // +-+-+-+-+-+-+-+-+\n      const singleByte = new BitWriter2(8).set(0).set(0, 5).set(0).set(1);\n\n      const iv = Buffer.alloc(16);\n      const ivCounter = this.trackIvs[trackNumber];\n      iv.writeUInt32BE(ivCounter[0], 0);\n      iv.writeUInt32BE(ivCounter[1], 4);\n      ivCounter[1]++;\n      if (ivCounter[1] === 0) {\n        ivCounter[0]++;\n      }\n\n      const cipher = createCipheriv(\"AES-128-CTR\", this.encryptionKey, iv);\n\n      frame = Buffer.concat([\n        singleByte.buffer,\n        iv.subarray(0, 8),\n        cipher.update(frame),\n        cipher.final(),\n      ]);\n    }\n\n    const contentSize: Uint8Array = EBML.vintEncodedNumber(\n      1 + 2 + 1 + frame.length,\n    ).bytes;\n\n    const keyframe = isKeyframe ? 1 : 0;\n    const flags = new BitWriter2(8)\n      .set(keyframe)\n      .set(0, 3)\n      .set(0)\n      .set(0, 2)\n      .set(0);\n\n    const simpleBlock = Buffer.concat([\n      elementId,\n      contentSize,\n      EBML.vintEncodedNumber(trackNumber).bytes,\n      new BufferChain(2).writeInt16BE(relativeTimestamp).buffer,\n      new BufferChain(1).writeUInt8(flags.value).buffer,\n      frame,\n    ]);\n    return simpleBlock;\n  }\n}\n\nexport const supportedCodecs = [\n  \"MPEG4/ISO/AVC\",\n  \"VP8\",\n  \"VP9\",\n  \"AV1\",\n  \"OPUS\",\n] as const;\nexport type SupportedCodec = (typeof supportedCodecs)[number];\nconst millisecond = 1000000;\n"]}