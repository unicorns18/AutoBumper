{"version":3,"file":"gcm.js","sourceRoot":"","sources":["../../../../../src/srtp/cipher/gcm.ts"],"names":[],"mappings":"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","sourcesContent":["import { createCipheriv, createDecipheriv } from \"crypto\";\n\nimport { CipherAesBase } from \".\";\nimport { createBufferWriter } from \"../../../../common/src\";\nimport { growBufferSize } from \"../../helper\";\nimport { RtcpHeader } from \"../../rtcp/header\";\nimport { RtpHeader } from \"../../rtp/rtp\";\n\nexport class CipherAesGcm extends CipherAesBase {\n  readonly aeadAuthTagLen = 16;\n  readonly rtpIvWriter = createBufferWriter([2, 4, 4, 2], true);\n  readonly rtcpIvWriter = createBufferWriter([2, 4, 2, 4], true);\n  readonly aadWriter = createBufferWriter([4], true);\n\n  constructor(\n    srtpSessionKey: Buffer,\n    srtpSessionSalt: Buffer,\n    srtcpSessionKey: Buffer,\n    srtcpSessionSalt: Buffer,\n  ) {\n    super(srtpSessionKey, srtpSessionSalt, srtcpSessionKey, srtcpSessionSalt);\n  }\n\n  encryptRtp(header: RtpHeader, payload: Buffer, rolloverCounter: number) {\n    const hdr = header.serialize(header.serializeSize);\n\n    const iv = this.rtpInitializationVector(header, rolloverCounter);\n\n    const cipher = createCipheriv(\"aes-128-gcm\", this.srtpSessionKey, iv);\n    cipher.setAAD(hdr);\n    const enc = cipher.update(payload);\n    cipher.final();\n\n    const authTag = cipher.getAuthTag();\n\n    const dst = Buffer.concat([hdr, enc, authTag]);\n    return dst;\n  }\n\n  decryptRtp(cipherText: Buffer, rolloverCounter: number): [Buffer, RtpHeader] {\n    const header = RtpHeader.deSerialize(cipherText);\n\n    let dst = Buffer.from([]);\n    dst = growBufferSize(dst, cipherText.length - this.aeadAuthTagLen);\n    cipherText.slice(0, header.payloadOffset).copy(dst);\n\n    const iv = this.rtpInitializationVector(header, rolloverCounter);\n\n    const enc = cipherText.slice(\n      header.payloadOffset,\n      cipherText.length - this.aeadAuthTagLen,\n    );\n\n    const cipher = createDecipheriv(\"aes-128-gcm\", this.srtpSessionKey, iv);\n    const dec = cipher.update(enc);\n\n    dec.copy(dst, header.payloadOffset);\n\n    return [dst, header];\n  }\n\n  encryptRTCP(rtcpPacket: Buffer, srtcpIndex: number): Buffer {\n    const ssrc = rtcpPacket.readUInt32BE(4);\n\n    const addPos = rtcpPacket.length + this.aeadAuthTagLen;\n    let dst = Buffer.from([]);\n    dst = growBufferSize(dst, addPos + srtcpIndexSize);\n    rtcpPacket.slice(0, 8).copy(dst);\n\n    const iv = this.rtcpInitializationVector(ssrc, srtcpIndex);\n    const aad = this.rtcpAdditionalAuthenticatedData(rtcpPacket, srtcpIndex);\n\n    const cipher = createCipheriv(\"aes-128-gcm\", this.srtcpSessionKey, iv);\n    cipher.setAAD(aad);\n    const enc = cipher.update(rtcpPacket.slice(8));\n    cipher.final();\n    enc.copy(dst, 8);\n\n    const authTag = cipher.getAuthTag();\n    authTag.copy(dst, 8 + enc.length);\n    aad.slice(8, 12).copy(dst, addPos);\n\n    return dst;\n  }\n\n  decryptRTCP(encrypted: Buffer): [Buffer, RtcpHeader] {\n    const header = RtcpHeader.deSerialize(encrypted);\n    const aadPos = encrypted.length - srtcpIndexSize;\n\n    const dst = Buffer.alloc(aadPos - this.aeadAuthTagLen);\n    encrypted.slice(0, 8).copy(dst);\n\n    const ssrc = encrypted.readUInt32BE(4);\n\n    let srtcpIndex = encrypted.readUInt32BE(encrypted.length - 4);\n    srtcpIndex &= ~(rtcpEncryptionFlag << 24);\n\n    const iv = this.rtcpInitializationVector(ssrc, srtcpIndex);\n    const aad = this.rtcpAdditionalAuthenticatedData(encrypted, srtcpIndex);\n\n    const cipher = createDecipheriv(\"aes-128-gcm\", this.srtcpSessionKey, iv);\n    cipher.setAAD(aad);\n    const dec = cipher.update(encrypted.slice(8, aadPos));\n\n    dec.copy(dst, 8);\n\n    return [dst, header];\n  }\n\n  // https://tools.ietf.org/html/rfc7714#section-8.1\n  private rtpInitializationVector(header: RtpHeader, rolloverCounter: number) {\n    const iv = this.rtpIvWriter([\n      0,\n      header.ssrc,\n      rolloverCounter,\n      header.sequenceNumber,\n    ]);\n    for (let i = 0; i < iv.length; i++) {\n      iv[i] ^= this.srtpSessionSalt[i];\n    }\n    return iv;\n  }\n\n  // https://tools.ietf.org/html/rfc7714#section-9.1\n  private rtcpInitializationVector(ssrc: number, srtcpIndex: number) {\n    const iv = this.rtcpIvWriter([0, ssrc, 0, srtcpIndex]);\n    for (let i = 0; i < iv.length; i++) {\n      iv[i] ^= this.srtcpSessionSalt[i];\n    }\n    return iv;\n  }\n\n  // https://datatracker.ietf.org/doc/html/rfc7714#section-17\n  private rtcpAdditionalAuthenticatedData(\n    rtcpPacket: Buffer,\n    srtcpIndex: number,\n  ) {\n    const aad = Buffer.concat([\n      rtcpPacket.subarray(0, 8),\n      this.aadWriter([srtcpIndex]),\n    ]);\n    aad[8] |= rtcpEncryptionFlag;\n    return aad;\n  }\n}\n\nconst srtcpIndexSize = 4;\nconst rtcpEncryptionFlag = 0x80;\n"]}